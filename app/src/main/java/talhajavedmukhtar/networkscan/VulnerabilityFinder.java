package talhajavedmukhtar.networkscan;

import android.content.Context;
import android.util.Log;

import java.io.BufferedReader;
import java.io.InputStreamReader;
import java.util.ArrayList;
import java.util.HashMap;

/**
 * Created by Talha on 10/22/18.
 */

public class VulnerabilityFinder {
    final String TAG = Tags.makeTag("VulnerabilityFinder");

    private Context context;

    //private HashMap<String,HashMap<String,ArrayList<String>>> vulnerabilityMap;

    //private HashMap<String,String> cveDB;

    /*public VulnerabilityFinder(Context c){
        Log.d(TAG,"Starting to create map");
        initializeMap(c);
        Log.d(TAG,"Map created!");
        Log.d(TAG,"Storing the db");
        initializeDatabase(c);
        Log.d(TAG,"DB stored.");
    }*/

    public VulnerabilityFinder(Context c){
        context = c;
    }

    /*private void populateProducts(Context c){
        BufferedReader bufferedReader = null;
        try{
            bufferedReader = new BufferedReader(new InputStreamReader(c.getAssets().open("vulnerabilityData/productsList.txt")));
            String line;
            while ((line = bufferedReader.readLine()) != null) {
                String productName = line.substring(0,line.length());
                HashMap<String,ArrayList<String>> newMap = new HashMap<>();
                if(productName.equals("folder_gallery")){
                    Log.d(TAG,"folder_gallery was encountered");
                }
                vulnerabilityMap.put(productName,newMap);
            }
        }catch (Exception ex){
            Log.d(TAG,ex.getMessage());
        }finally {
            if (bufferedReader != null) {
                try {
                    bufferedReader.close();
                } catch (Exception ex) {
                    Log.d(TAG,ex.getMessage());
                }
            }
        }

    }*/

    private ArrayList<String> getArrayFromString(String arr){
        String withoutBrackets = arr.substring(1,arr.length()-1);
        String[] elements = withoutBrackets.split(", ");

        ArrayList<String> arrFromString = new ArrayList<>();

        for(String elem: elements){
            String clean = elem.substring(1,elem.length()-1);

            arrFromString.add(clean);
        }

        return arrFromString;
    }

    /*private void initializeMap(Context c){
        vulnerabilityMap = new HashMap<>();

        populateProducts(c);

        Log.d(TAG,"Done populating");

        BufferedReader bufferedReader = null;
        try{
            bufferedReader = new BufferedReader(new InputStreamReader(c.getAssets().open("vulnerabilityData/dataFile.txt")));
            String line;
            while ((line = bufferedReader.readLine()) != null) {
                line = line.substring(0,line.length());
                String[] parts = line.split(" : ");

                String product = parts[0];
                String version = parts[1];
                ArrayList<String> idents = getArrayFromString(parts[2]);

                //Log.d(TAG,"Trying for prod: "+ product);

                vulnerabilityMap.get(product).put(version,idents);
            }
        }catch (Exception ex){
            Log.d(TAG,ex.getMessage());
        }finally {
            if (bufferedReader != null) {
                try {
                    bufferedReader.close();
                } catch (Exception ex) {
                    Log.d(TAG,ex.getMessage());
                }
            }
        }
    }

    private void initializeDatabase(Context c){
        cveDB = new HashMap<>();

        BufferedReader bufferedReader = null;
        try{
            bufferedReader = new BufferedReader(new InputStreamReader(c.getAssets().open("vulnerabilityData/compactCVE.txt")));
            String line;
            while ((line = bufferedReader.readLine()) != null) {
                String[] parts = line.split(" : ");
                String ident = parts[0];
                String description = parts[1];

                cveDB.put(ident,description);
            }
        }catch (Exception ex){
            Log.d(TAG,ex.getMessage());
        }finally {
            if (bufferedReader != null) {
                try {
                    bufferedReader.close();
                } catch (Exception ex) {
                    Log.d(TAG,ex.getMessage());
                }
            }
        }

    }*/

    public ArrayList<String> getIdents(String product, String version){
        if (product.length() == 0){
            return new ArrayList<>();
        }

        char firstChar = product.charAt(0);

        char[] plausibe = {'0', '1', '2', '3', '4', '5', '6', '7', '8', '9', 'a',
                'b', 'c', 'd', 'e', 'f', 'g', 'h', 'i', 'j', 'k', 'l', 'm', 'n',
                'o', 'p', 'q', 'r', 's', 't', 'u', 'v', 'w', 'x', 'y', 'z'};

        if(new String(plausibe).indexOf(firstChar) != -1){
            BufferedReader bufferedReader = null;
            try{
                bufferedReader = new BufferedReader(new InputStreamReader(context.getAssets().open("vulnerabilityData/vulns/"+firstChar+".txt")));
                String line;
                while ((line = bufferedReader.readLine()) != null) {
                    line = line.substring(0,line.length());
                    String[] parts = line.split(" : ");

                    String prod = parts[0];
                    String vers = parts[1];
                    ArrayList<String> idents = getArrayFromString(parts[2]);

                    if (prod.equals(product) && vers.equals(version)){ //this is what we are looking for!
                        return idents;
                    }
                }
            }catch (Exception ex){
                Log.d(TAG,ex.getMessage());
            }finally {
                if (bufferedReader != null) {
                    try {
                        bufferedReader.close();
                    } catch (Exception ex) {
                        Log.d(TAG,ex.getMessage());
                    }
                }
            }
        }

        return new ArrayList<>();
    }

    public String getCVEDescription(String ident){
        String year = ident.split("-")[1];

        BufferedReader bufferedReader = null;
        try{
            bufferedReader = new BufferedReader(new InputStreamReader(context.getAssets().open("vulnerabilityData/CVE/"+year+".txt")));
            String line;
            while ((line = bufferedReader.readLine()) != null) {
                String[] parts = line.split(" : ");
                String identifier = parts[0];
                String description = parts[1];

                if (identifier.equals(ident)){
                    return description;
                }
            }
        }catch (Exception ex){
            Log.d(TAG,ex.getMessage());
        }finally {
            if (bufferedReader != null) {
                try {
                    bufferedReader.close();
                } catch (Exception ex) {
                    Log.d(TAG,ex.getMessage());
                }
            }
        }

        return "";
    }

    public ArrayList<String> getVulnerabilities(String prod, String vers){
        ArrayList<String> descriptions = new ArrayList<>();
        ArrayList<String> idents = getIdents(prod,vers);
        for(String ident: idents){
            descriptions.add(getCVEDescription(ident));
        }
        return descriptions;
    }

}
